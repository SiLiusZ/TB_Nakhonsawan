<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>รายงานผลการคัดกรองวัณโรค</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
    
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-2.31.1.min.js"></script>
    
    <!-- Google Font: Sarabun -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom font family: Sarabun */
        body { font-family: 'Sarabun', sans-serif; }
        /* Style for Chart container - Modified to a single flexible area */
        #charts-area { 
            /* min-height: 600px; - Removed fixed min-height */
            display: flex;
            flex-wrap: wrap; /* Allows wrapping on smaller screens */
            justify-content: center;
            align-items: flex-start;
        }
        /* Style for individual charts */
        .chart-plot-container {
            width: 100%; /* Default to full width on mobile */
            padding: 1rem;
        }
        /* Responsive sizing for large screens (e.g., desktop) */
        @media (min-width: 1024px) {
            .chart-plot-container.group-chart {
                /* ลบคลาส lg:w-1/2 เพื่อให้เรียงซ้อนกันในแนวตั้ง */
                /* width: calc(50% - 1rem); */
            }
        }
        
        .data-table th, .data-table td { border-bottom: 1px solid #e5e7eb; }
        .data-table th { background-color: #f3f4f6; }
        
        /* Sleek Button Hover Effect */
        .btn-sleek {
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-sleek:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }
        
        /* เพิ่มสไตล์สำหรับผลลัพธ์ Markdown ที่แปลงแล้ว */
        #ai-analysis-output h4 {
            font-size: 1.5rem; /* text-xl */
            font-weight: 700; /* font-bold */
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            color: #1f2937; /* gray-800 */
        }
        /* NEW: Style for paragraphs created by conversion */
        #ai-analysis-output p {
            margin-bottom: 1rem;
        }
        /* Style for Ordered Lists */
        #ai-analysis-output ol {
            list-style-type: decimal;
            margin-left: 1.5rem;
            padding-left: 0.5rem;
            margin-bottom: 1rem;
        }
        #ai-analysis-output li {
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Navbar -->
    <nav class="bg-gray-800 shadow-xl"> 
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <a href="report.html" class="text-white text-2xl font-extrabold tracking-wider">รายงานผล</a>
                    <div class="hidden sm:ml-6 sm:flex sm:space-x-4">
                        <a href="report.html" class="bg-gray-700 text-white px-3 py-2 rounded-md text-sm font-medium transition duration-150">หน้าหลัก</a>
                        <a href="admin.html" class="text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium transition duration-150">หน้าสำหรับแอดมิน</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container max-w-7xl mx-auto mt-8 p-4 sm:p-6 lg:p-8">
        <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-2xl border border-gray-200">
            <h2 class="text-3xl font-bold text-center text-gray-900 mb-6 border-b-4 border-blue-600 pb-3"> 
                รายงานผลการคัดกรองวัณโรคแยกตามสถานบริการ
            </h2>
            
            <!-- Firebase Status Panel (NEW) -->
            <div id="firebaseStatus" class="mb-6 p-4 rounded-xl text-sm bg-blue-50 border border-blue-200 text-center">
                <span id="dataStatus" class="font-semibold text-blue-800">กำลังเชื่อมต่อและโหลดข้อมูล...</span>
            </div>

            <!-- Filter Control -->
            <div class="controls flex justify-center mb-8 bg-gray-50 p-4 rounded-xl shadow-inner border border-gray-200"> 
                <label for="hospitalFilter" class="text-lg font-semibold text-gray-700 self-center mr-4">
                    ตัวกรองสถานบริการ:
                </label>
                <select id="hospitalFilter" onchange="filterData()" 
                        class="px-4 py-2 border border-gray-300 rounded-xl shadow-sm focus:ring-blue-500 focus:border-blue-500 w-full sm:w-auto">
                    <option value="All">-- แสดงทั้งหมด --</option>
                </select>
            </div>

            <!-- Chart Container (Plotly) -->
            <div id="charts-area" class="flex flex-wrap justify-center -mx-2 mb-12">
                <!-- กราฟที่ 1: อัตราคัดกรองรวมรายสถานบริการ -->
                <div id="chart-main-overall" class="chart-plot-container w-full bg-white shadow-xl rounded-xl p-4 border border-gray-100">
                    <!-- Plotly chart will be injected here (used for Overall View) -->
                </div>
                
                <!-- กราฟที่ 2: ภาพรวมรายกลุ่มเสี่ยง (แสดงเฉพาะเมื่อเลือก All) -->
                <div id="chart-group-comparison" class="chart-plot-container w-full bg-white shadow-xl rounded-xl p-4 border border-gray-100">
                    <!-- Plotly chart will be injected here (used for Overall Group Comparison) -->
                </div>
            </div>

            <!-- Summary Table -->
            <div class="mt-10">
                <h3 class="text-2xl font-bold text-center text-gray-700 mb-6">ตารางข้อมูลสรุปผลการคัดกรอง</h3>
                <div id="table-container" class="overflow-x-auto shadow-2xl rounded-xl border border-gray-200">
                    <!-- Table will be rendered here -->
                </div>
            </div>
            
            <!-- NEW AI ANALYSIS SECTION -->
            <div class="mt-10 bg-white p-6 rounded-2xl shadow-2xl border border-gray-200">
                <h3 class="text-2xl font-bold text-gray-700 mb-4 border-b-2 pb-2 text-center sm:text-left">
                    การวิเคราะห์ผลเชิงลึกโดย AI (Deep Analysis)
                </h3>
                <!-- Title and date are generated here before the main output -->
                <div class="text-sm text-gray-500 mb-4 border-b pb-2">
                    รายงานการวิเคราะห์ข้อมูลโครงการคัดกรองวัณโรคเชิงรุก วันที่: **21 ตุลาคม 2568**
                </div>
                <div id="ai-analysis-output" class="text-gray-800 text-lg leading-relaxed min-h-[100px] flex items-center justify-center">
                    <!-- AI Analysis content or loading indicator -->
                    <span class="text-gray-500">รอการประมวลผลการวิเคราะห์...</span>
                </div>
            </div>
            
        </div>
    </div>

    <!-- Insert Firebase Config Variables Here (Same as admin.html) -->
    <script>
        // *** ค่าเหล่านี้ถูกกำหนดโดย Firebase Project ของคุณ ***
        const __app_id = "1:743854393345:web:cc3f5ac35d595b0fbe9800"; 
        
        const __firebase_config = JSON.stringify({
            // *** API KEY ล่าสุดที่คุณให้มา: คีย์นี้ใช้สำหรับ Firebase และจะถูกใช้เรียก Gemini API ***
            apiKey: "AIzaSyD36zBXb8nF2rBwQlKVpHzgq5_2bg7j9cE", 
            authDomain: "tbelf-54285.firebaseapp.com",
            projectId: "tbelf-54285",
            storageBucket: "tbelf-54285.firebasestorage.app",
            messagingSenderId: "743854393345",
            appId: __app_id 
        });
        
        const __initial_auth_token = null; 
    </script>
    
    <!-- Firebase SDK Imports and Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, query, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        setLogLevel('debug'); // Enable debug logging for Firebase operations

        // --- GLOBAL VARIABLES (Config from <script> block) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        
        let db; 
        let MOCK_DATA = {}; 
        
        // --- โครงสร้างข้อมูลหลัก (คัดลอกมาจาก report.html เดิม) ---
        const HOSPITALS = [
            "โรงพยาบาลสวรรค์ประชารักษ์", "โรงพยาบาลเก้าเลี้ยว", "โรงพยาบาลโกรกพระ", "โรงพยาบาลชุมตาบง", "โรงพยาบาลชุุมแสง", "โรงพยาบาลตากฟ้า", 
            "โรงพยาบาลตาคลี", "โรงพยาบาลบรรพตพิสัย", "โรงพยาบาลพยุหะคีรี", "โรงพยาบาลท่าตะโก", "โรงพยาบาลไพศาลี", "โรงพยาบาลแม่วงก์", 
            "โรงพยาบาลหนองบัว", "โรงพยาบาลลาดยาว"
        ];

        const RISK_GROUPS = [
            "1. ผู้สัมผัสผู้ป่วยวัณโรคปอด", "2. ผู้ติดเชื้อเอชไอวี", "3. ผู้ป่วย DM HbA1C ≥ 7 mg%", "4. ผู้ป่วยโรคไตเรื้อรัง", "5. ผู้ที่ได้รับยากดภูมิ", 
            "6. ผู้ต้องขัง", "7. ผู้สูงอายุ ≥ 65 ปี ที่มีโรคร่วมเบาหวาน", "8. ผู้สูงอายุ ≥ 65 ปี ที่มีโรคร่วมปอดอุดกั้นเรื้อรัง COPD", 
            "9. ผู้สูงอายุ ≥ 65 ปี ที่สูบบุหรี่", "10. ผู้ใช้สารเสพติด+ผู้ติดสุราเรื้อรัง", "11. บุคลากรสาธารณสุข"
        ];
        
        const SUCCESS_THRESHOLDS = {
            "0. ภาพรวม (ทั้งหมด)": 90, // อัปเดตจาก 80 เป็น 90
            "1. ผู้สัมผัสผู้ป่วยวัณโรคปอด": 70, 
            "2. ผู้ติดเชื้อเอชไอวี": 100,      
            "3. ผู้ป่วย DM HbA1C ≥ 7 mg%": 90, 
            "4. ผู้ป่วยโรคไตเรื้อรัง": 90,     
            "5. ผู้ที่ได้รับยากดภูมิ": 90,     
            "6. ผู้ต้องขัง": 100,              
            "7. ผู้สูงอายุ ≥ 65 ปี ที่มีโรคร่วมเบาหวาน": 90, 
            "8. ผู้สูงอายุ ≥ 65 ปี ที่มีโรคร่วมปอดอุดกั้นเรื้อรัง COPD": 90, 
            "9. ผู้สูงอายุ ≥ 65 ปี ที่สูบบุหรี่": 90, 
            "10. ผู้ใช้สารเสพติด+ผู้ติดสุราเรื้อรัง": 90, 
            "11. บุคลากรสาธารณสุข": 90 
        };
        
        const DATA_STORAGE_KEY = 'tbScreeningDataV2'; 


        // --- FIREBASE INITIALIZATION & DATA LOAD LOGIC ---
        
        function getCollectionPath() {
            return `artifacts/${appId}/public/data/tbScreening`;
        }
        
        // 1. Load data from Firestore (or fallback to Local Storage)
        async function loadAllData() {
            const statusDiv = document.getElementById('dataStatus');
            statusDiv.textContent = 'กำลังเชื่อมต่อและโหลดข้อมูล...';
            
            function generateInitialDataStructure() {
                const initialData = {};
                HOSPITALS.forEach(h => {
                    initialData[h] = {};
                    RISK_GROUPS.forEach(r => {
                        initialData[h][r] = { target: 0, screened: 0 };
                    });
                });
                return initialData;
            }

            function loadDataFromLocalStorage() {
                const storedData = localStorage.getItem(DATA_STORAGE_KEY);
                return storedData ? JSON.parse(storedData) : generateInitialDataStructure();
            }

            if (Object.keys(firebaseConfig).length > 0) {
                try {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    
                    const collectionRef = collection(db, getCollectionPath());
                    const q = query(collectionRef);
                    const querySnapshot = await getDocs(q);
                    
                    let firestoreData = {};
                    querySnapshot.forEach((doc) => {
                        firestoreData[doc.id] = doc.data();
                    });
                    
                    statusDiv.textContent = 'เชื่อมต่อและโหลดข้อมูลจาก Firestore สำเร็จ!';
                    statusDiv.classList.remove('text-blue-800', 'text-red-700', 'text-yellow-700');
                    statusDiv.classList.add('text-green-700');
                    return firestoreData;
                    
                } catch (error) {
                    console.error("Error loading data from Firestore, falling back to Local Storage:", error);
                    statusDiv.textContent = `ข้อผิดพลาดในการโหลดข้อมูลจาก Firestore (ใช้ Local Data แทน)`;
                    statusDiv.classList.remove('text-blue-800', 'text-green-700', 'text-yellow-700');
                    statusDiv.classList.add('text-red-700');
                    return loadDataFromLocalStorage();
                }
            } else {
                statusDiv.textContent = 'ไม่ได้เชื่อมต่อ Firebase (ใช้ Local Mock Data)';
                statusDiv.classList.remove('text-blue-800', 'text-red-700', 'text-green-700');
                statusDiv.classList.add('text-yellow-700');
                return loadDataFromLocalStorage();
            }
        }

        // --- AI Analysis Logic ---

        // Function to handle API calls with exponential backoff
        // MODIFIED: Increase retries to 8 and starting delay to 3000ms for better 503 handling
        async function fetchWithBackoff(url, options, retries = 8, delay = 3000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response;
                    }
                    if (i < retries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; 
                        continue;
                    }
                    throw new Error(`API request failed with status ${response.status}: ${await response.text()}`);
                } catch (error) {
                    if (i === retries - 1) {
                        throw error;
                    }
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
        }

        async function generateAIAnalysis(processedHospitalData, overallGroupData, hospitalSelected) {
            const outputDiv = document.getElementById('ai-analysis-output');
            outputDiv.classList.remove('text-red-600', 'text-gray-800');
            outputDiv.classList.add('text-gray-500');
            outputDiv.innerHTML = '<div class="flex flex-col items-center"><svg class="animate-spin h-5 w-5 text-blue-500 mr-3" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>กำลังประมวลผลการวิเคราะห์เชิงลึกโดย AI...</span></div>';

            if (hospitalSelected !== 'All') {
                outputDiv.innerHTML = '<span class="text-gray-500">การวิเคราะห์เชิงลึกโดย AI จะแสดงเมื่อเลือก "แสดงทั้งหมด"</span>';
                return;
            }

            try {
                // --- 1. Data Preparation ---
                const hospitalSummary = processedHospitalData.map(d => ({
                    hospital: d.hospital,
                    percentage: parseFloat(d.percentage.toFixed(2)),
                    totalTarget: d.totalTarget,
                    totalScreened: d.totalScreened,
                }));

                const riskGroupSummary = overallGroupData
                    .filter(d => d.originalLabel !== "0. ภาพรวม (ทั้งหมด)") 
                    .map(d => ({
                        riskGroup: d.originalLabel,
                        percentage: parseFloat(d.percentage.toFixed(2)),
                        targetPct: d.targetPct,
                        totalTarget: d.target,
                        totalScreened: d.screened,
                    }));
                
                // --- 2. Prompt Construction (ADJUSTED PROMPT FOR NUMBERED PARAGRAPHS) ---
                const systemPrompt = "Act as a public health data analyst specializing in Tuberculosis (TB) screening programs. Your task is to analyze the provided screening data (Hospital performance and Risk Group performance) and generate a concise, actionable report in Thai. The report must contain three prioritized sections: 1. Key Successes (Best Performers/Groups exceeding targets). 2. Key Challenges (Worst Performers/Groups significantly below targets). 3. Top 3 Actionable Recommendations. CRITICAL: The content within Key Successes and Key Challenges sections MUST be formatted as a single numbered list (1., 2., 3., ...) where each numbered item is a complete, descriptive paragraph explaining a finding or challenge. Do NOT use bullet points or extra line breaks within the numbered paragraphs.";

                const userQuery = `Analyze the following TB screening data:
                
                A. Hospital Overall Performance (Sorted by percentage, descending):
                ${JSON.stringify(hospitalSummary)}

                B. Risk Group Performance (Including specific target percentages, sorted by priority):
                ${JSON.stringify(riskGroupSummary)}

                Provide the analysis structured as requested in the system instructions. Ensure the output is readable and in Thai (Markdown format is preferred for readability).`;

                // ** FIX: Use the actual apiKey from the firebaseConfig variable **
                const apiKey = firebaseConfig.apiKey || ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                };

                // --- 3. API Call ---
                const response = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const generatedText = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                // --- 4. Render Output (ADJUSTED CONVERSION FOR NUMBERED PARAGRAPHS) ---
                if (generatedText) {
                    let htmlContent = generatedText;
                    
                    // 1. Convert Headers (###) to <h4>
                    htmlContent = htmlContent.replace(/###\s*(.*)/g, '<h4>$1</h4>');
                    
                    // 2. Convert Bold (**Text**) to <strong>Text</strong>
                    htmlContent = htmlContent.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); 

                    // 3. Convert Numbered List items (1. Text) to <li> tags
                    // Look for numbers followed by a dot and space at the start of a line
                    htmlContent = htmlContent.replace(/^(\d+\.)\s+(.*)/gm, '<li><strong>$1</strong> $2</li>');

                    // 4. Wrap blocks of <li> elements into <ol> tags
                    // This relies on the numbered lists being contiguous (which the prompt mandates)
                    htmlContent = htmlContent.replace(/(<li>.*<\/li>(\s*<li>.*<\/li>)*)/g, '<ol>$1</ol>');
                    
                    // 5. Convert remaining consecutive newlines (\n\n) to Paragraphs (<p>...</p>)
                    // Note: Since we are asking the model to write paragraphs, we expect most content to be block-level (either <h4>, <ol>, or separated by \n\n).

                    // Wrap the entire content in a temporary div to simplify paragraph detection
                    htmlContent = `<div>${htmlContent}</div>`;
                    
                    // Replace all triple+ newlines with double newlines
                    htmlContent = htmlContent.replace(/\n\s*\n\s*\n/g, '\n\n');
                    
                    // Split content by double newline (paragraph break)
                    htmlContent = htmlContent.split('\n\n').map(p => {
                        // Check if the block already starts with a block-level tag
                        if (p.startsWith('<h4>') || p.startsWith('<ol>') || p.trim() === '') {
                            return p;
                        }
                        // Wrap remaining text blocks in <p> tags
                        // Replace single newlines within a block with spaces for proper paragraph flow
                        return `<p>${p.replace(/\n/g, ' ')}</p>`; 
                    }).join('');

                    // Remove temporary div and clean up unnecessary line breaks
                    htmlContent = htmlContent.replace(/^<div>/, '').replace(/<\/div>$/, '');
                    
                    // Final cleanup: remove residual standalone newlines 
                    htmlContent = htmlContent.replace(/\n/g, '');


                    outputDiv.innerHTML = htmlContent;
                    outputDiv.classList.remove('text-gray-500');
                    outputDiv.classList.add('text-gray-800');
                } else {
                    throw new Error("Failed to extract analysis text from API response.");
                }

            } catch (error) {
                console.error("AI Analysis failed:", error);
                outputDiv.innerHTML = `<span class="font-bold">ข้อผิดพลาดในการวิเคราะห์ข้อมูล:</span> ไม่สามารถเชื่อมต่อหรือประมวลผลข้อมูล AI ได้ (${error.message})`;
                outputDiv.classList.remove('text-gray-500');
                outputDiv.classList.add('text-red-600');
            }
        }


        // --- Data Processor (เดิม) ---
        function processData(dataToProcess) {
            let summary = {};
            
            for (const hospital in dataToProcess) {
                if (dataToProcess.hasOwnProperty(hospital)) {
                    const riskGroupDetails = dataToProcess[hospital];
                    
                    let totalTarget = 0;
                    let totalScreened = 0;
                    let details = [];

                    for (const riskGroup in riskGroupDetails) {
                        const data = riskGroupDetails[riskGroup];
                        const target = parseInt(data.target) || 0;
                        const screened = parseInt(data.screened) || 0;
                        const remaining = target - screened;

                        totalTarget += target;
                        totalScreened += screened;
                        details.push({ riskGroup, target, screened, remaining });
                    }

                    const percentage = totalTarget > 0 ? (totalScreened / totalTarget) * 100 : 0;
                    
                    summary[hospital] = {
                        hospital: hospital, 
                        totalTarget: totalTarget,
                        totalScreened: totalScreened,
                        percentage: percentage,
                        details: details
                    };
                }
            }
            
            let chartData = Object.values(summary);
            chartData.sort((a, b) => b.percentage - a.percentage);
            return chartData;
        }
        
        // --- NEW FUNCTION: Get Overall Group Comparison Data (เดิม) ---
        function getOverallGroupData(dataToProcess) {
            const overallGroupSummary = {};

            for (const hospital in dataToProcess) {
                const riskGroupDetails = dataToProcess[hospital];
                for (const riskGroup in riskGroupDetails) {
                    const data = riskGroupDetails[riskGroup];
                    const target = parseInt(data.target) || 0;
                    const screened = parseInt(data.screened) || 0;

                    if (!overallGroupSummary[riskGroup]) {
                        overallGroupSummary[riskGroup] = { target: 0, screened: 0 };
                    }

                    overallGroupSummary[riskGroup].target += target;
                    overallGroupSummary[riskGroup].screened += screened;
                }
            }

            const chartData = [];
            for (const riskGroup in overallGroupSummary) {
                const { target, screened } = overallGroupSummary[riskGroup];
                const percentage = target > 0 ? (screened / target) * 100 : 0;
                const targetPct = SUCCESS_THRESHOLDS[riskGroup] || 100;

                chartData.push({
                    originalLabel: riskGroup,
                    label: formatRiskGroupLabel(riskGroup),
                    target: target,
                    screened: screened,
                    percentage: percentage,
                    targetPct: targetPct
                });
            }
            
            const totalTarget = chartData.reduce((sum, d) => sum + d.target, 0);
            const totalScreened = chartData.reduce((sum, d) => sum + d.screened, 0);
            const overallPercentage = totalTarget > 0 ? (totalScreened / totalTarget) * 100 : 0;
            const overallLabel = "0. ภาพรวม (ทั้งหมด)";
            
            chartData.push({
                originalLabel: overallLabel,
                label: overallLabel,
                target: totalTarget,
                screened: totalScreened,
                percentage: overallPercentage,
                targetPct: SUCCESS_THRESHOLDS[overallLabel] || 100
            });
            
            chartData.sort((a, b) => {
                const priorityA = getCustomSortPriority(a.originalLabel);
                const priorityB = getCustomSortPriority(b.originalLabel);
                return priorityA - priorityB;
            });

            return chartData;
        }

        // --- Function to add \n to long labels for horizontal chart Y-axis (เดิม) ---
        function formatRiskGroupLabel(label) {
            if (!label) return label;
            
            let formattedLabel = label
                .replace(" ที่มีโรคร่วมเบาหวาน", "\nที่มีโรคร่วมเบาหวาน")
                .replace(" ที่มีโรคร่วมปอดอุดกั้นเรื้อรัง COPD", "\nที่มีโรคร่วมปอดอุดกั้นเรื้อรัง COPD")
                .replace(" ที่สูบบุหรี่", "\nที่สูบบุหรี่")
                .replace("+ผู้ติดสุราเรื้อรัง", "\n+ผู้ติดสุสุราเรื้อรัง")
                .replace("ผู้สัมผัสผู้ป่วยวัณโรคปอด", "ผู้สัมผัส\nผู้ป่วยวัณโรคปอด")
                .replace("บุคลากรสาธารณสุข", "บุคลากร\nสาธารณสุข");

            return formattedLabel;
        }
        
        // --- Function to assign custom priority for sorting (เดิม) ---
        function getCustomSortPriority(label) {
            if (label.includes("0. ภาพรวม")) return 1;
            if (label.includes("1. ผู้สัมผัสผู้ป่วยวัณโรคปอด")) return 2;
            if (label.includes("2. ผู้ติดเชื้อเอชไอวี")) return 3;
            if (label.includes("6. ผู้ต้องขัง")) return 4;
            
            const originalIndexMatch = label.match(/^(\d+)/);
            if (originalIndexMatch) {
                return 100 + parseFloat(originalIndexMatch[1]);
            }
            return 999;
        }


        // --- Get All Risk Group Data for a specific hospital (เดิม) ---
        function getGroupComparisonData(hospitalData) {
            if (!hospitalData || hospitalData.length === 0) return [];
            
            const hData = hospitalData[0]; 
            const comparisonData = [];

            hData.details.forEach(detail => {
                const originalLabel = detail.riskGroup;
                const targetPct = SUCCESS_THRESHOLDS[originalLabel] || 100; 
                
                comparisonData.push({
                    hospital: hData.hospital,
                    label: formatRiskGroupLabel(originalLabel),
                    originalLabel: originalLabel, 
                    percentage: detail.target > 0 ? (detail.screened / detail.target) * 100 : 0,
                    target: detail.target,      
                    screened: detail.screened,  
                    targetPct: targetPct
                });
            });
            
            const overallLabel = "0. ภาพรวม (ทั้งหมด)";
            comparisonData.push({
                hospital: hData.hospital,
                label: overallLabel,
                originalLabel: overallLabel, 
                percentage: hData.percentage,
                target: hData.totalTarget,
                screened: hData.totalScreened,
                targetPct: SUCCESS_THRESHOLDS[overallLabel] || 100
            });
            
            comparisonData.sort((a, b) => {
                const priorityA = getCustomSortPriority(a.originalLabel);
                const priorityB = getCustomSortPriority(b.originalLabel);
                return priorityA - priorityB;
            });

            return comparisonData;
        }

        // --- Plotly Chart Rendering Logic (เดิม) ---
        function drawChart(data, isComparisonView, targetDivId = 'chart-main-overall', titleOverride = null) {
            const chartContainer = document.getElementById(targetDivId);
            
            let labels, percentages, chartTitle, marginConfig;
            
            const orientation = 'h'; 
            let traces = [];
            let shapes = []; 
            let annotations = []; 

            if (!data || data.length === 0) {
                chartContainer.innerHTML = '<div class="text-center p-4 text-sm text-gray-500">ไม่พบข้อมูลสำหรับกลุ่มนี้</div>';
                return;
            }

            const isOverallHospitalView = targetDivId === 'chart-main-overall';
            const isOverallGroupView = targetDivId === 'chart-group-comparison';

            const baseHeight = 350;
            const rowHeight = 40;
            let calculatedHeight = Math.max(baseHeight, data.length * rowHeight + 120);

            if (isOverallHospitalView) {
                labels = data.map(d => d.hospital);
                percentages = data.map(d => d.percentage);
                chartTitle = 'อัตราการคัดกรองวัณโรคตามกลุ่มเสี่ยง (ภาพรวม)';
                marginConfig = { l: 250, r: 50, t: 80, b: 50 }; 
                
                const traceOverall = {
                    x: percentages, 
                    y: labels,
                    name: 'อัตราคัดกรอง (%)',
                    type: 'bar',
                    orientation: orientation,
                    marker: { 
                        color: data.map(d => d.percentage >= 90 ? '#059669' : '#dc2626'), // อัปเดตจาก 80 เป็น 90
                        line: { color: 'white', width: 1 }
                    }, 
                    text: percentages.map(p => `${p.toFixed(2)}%`), 
                    textposition: 'auto',
                    textfont: { size: 14, family: 'Sarabun, sans-serif' }, 
                    hovertemplate: '<b>%{y}</b><br>อัตราคัดกรอง: %{x:.2f}%<br>เป้าหมายรวม: %{customdata[0]:,}<br>ผลการคัดกรอง: %{customdata[1]:,}<extra></extra>',
                    customdata: data.map(d => [d.totalTarget, d.totalScreened])
                };
                traces.push(traceOverall);
                
                 shapes.push({
                    type: 'line',
                    xref: 'x', yref: 'paper', x0: 90, x1: 90, y0: 0, y1: 1, // อัปเดตจาก 80 เป็น 90
                    line: { color: 'red', width: 2, dash: 'dash' }
                });
                annotations.push({
                    xref: 'x', yref: 'paper', x: 90, y: 1.05, // อัปเดตจาก 80 เป็น 90
                    text: 'เป้าหมาย 90%', showarrow: false, 
                    xanchor: 'left', font: { color: 'red', size: 14, family: 'Sarabun, sans-serif' }
                });


            } else if (isOverallGroupView) {
                labels = data.map(d => d.label);
                percentages = data.map(d => d.percentage);
                chartTitle = 'อัตราการคัดกรองรวม: แยกตามกลุ่มความเสี่ยง (ทุกสถานบริการรวมกัน)';
                marginConfig = { l: 400, r: 100, t: 60, b: 50 }; 
                
                const traceScreening = {
                    x: percentages, 
                    y: labels,
                    name: 'อัตราคัดกรอง (%)',
                    type: 'bar',
                    orientation: orientation,
                    marker: { 
                        color: data.map(d => {
                            const targetPct = d.targetPct || 0;
                            return d.percentage >= targetPct ? '#10b981' : '#f59e0b'; 
                        }),
                        line: { color: 'white', width: 1 }
                    },
                    text: percentages.map(p => `${p.toFixed(2)}%`),
                    textposition: 'outside',
                    textfont: { size: 14, family: 'Sarabun, sans-serif' },
                    hovertemplate: '<b>%{y}</b><br>อัตราคัดกรอง: %{x:.2f}%<br>เป้าหมาย **(Target): %{customdata[2]}%**<br>เป้าหมายรวม: %{customdata[0]:,}<br>ผลการคัดกรองรวม: %{customdata[1]:,}<extra></extra>',
                    customdata: data.map(d => [d.target, d.screened, d.targetPct])
                };
                traces.push(traceScreening);
                
                const uniqueTargets = [...new Set(data.map(d => d.targetPct))].filter(t => t > 0);

                uniqueTargets.forEach(target => {
                    data.forEach((d, index) => {
                        if (d.targetPct === target) {
                            shapes.push({
                                type: 'line', xref: 'x', yref: 'y',
                                x0: target, x1: target, 
                                y0: index - 0.2, y1: index + 0.2, 
                                line: { color: 'red', width: 2, dash: 'dot' }
                            });

                            const isPriorityGroup = d.originalLabel.includes('0. ภาพรวม') || d.originalLabel.includes('1. ผู้สัมผัส') || d.originalLabel.includes('2. ผู้ติดเชื้อ') || d.originalLabel.includes('6. ผู้ต้องขัง');
                            
                            if (isPriorityGroup || target === 90) { 
                                annotations.push({
                                    xref: 'x', yref: 'y', x: target, y: index, 
                                    text: `${target}% (เป้าหมาย)`, showarrow: false,
                                    xanchor: 'left', yanchor: 'middle', xshift: 5, 
                                    font: { color: 'red', size: 14, family: 'Sarabun, sans-serif' }
                                });
                            }
                        }
                    });
                });

            } else {
                labels = data.map(d => d.label);
                percentages = data.map(d => d.percentage);
                chartTitle = titleOverride || `อัตราการคัดกรอง: ${data[0].hospital} (แยกตามกลุ่มเสี่ยง)`;
                marginConfig = { l: 400, r: 100, t: 60, b: 50 }; 
                
                const traceScreening = {
                    x: percentages, 
                    y: labels,
                    name: 'อัตราคัดกรอง (%)',
                    type: 'bar',
                    orientation: orientation,
                    marker: { 
                        color: data.map(d => {
                            const targetPct = d.targetPct || 0;
                            return d.percentage >= targetPct ? '#10b981' : '#f59e0b';
                        }),
                        line: { color: 'white', width: 1 }
                    },
                    text: percentages.map(p => `${p.toFixed(2)}%`),
                    textposition: 'outside',
                    textfont: { size: 14, family: 'Sarabun, sans-serif' },
                    hovertemplate: '<b>%{y}</b><br>อัตราคัดกรอง: %{x:.2f}%<br>เป้าหมาย **(Target): %{customdata[2]}%**<br>เป้าหมาย: %{customdata[0]:,}<br>ผลการคัดกรอง: %{customdata[1]:,}<extra></extra>',
                    customdata: data.map(d => [d.target, d.screened, d.targetPct])
                };
                traces.push(traceScreening);
                
                const uniqueTargets = [...new Set(data.map(d => d.targetPct))].filter(t => t > 0);

                uniqueTargets.forEach(target => {
                    data.forEach((d, index) => {
                        if (d.targetPct === target) {
                            shapes.push({
                                type: 'line', xref: 'x', yref: 'y',
                                x0: target, x1: target, y0: index - 0.2, y1: index + 0.2, 
                                line: { color: 'red', width: 2, dash: 'dot' }
                            });
                            const isPriorityGroup = d.originalLabel.includes('0. ภาพรวม') || d.originalLabel.includes('1. ผู้สัมผัส') || d.originalLabel.includes('2. ผู้ติดเชื้อ') || d.originalLabel.includes('6. ผู้ต้องขัง');
                            if (isPriorityGroup || target === 90) { 
                                annotations.push({
                                    xref: 'x', yref: 'y', x: target, y: index, 
                                    text: `${target}% (เป้าหมาย)`, showarrow: false,
                                    xanchor: 'left', yanchor: 'middle', xshift: 5, 
                                    font: { color: 'red', size: 14, family: 'Sarabun, sans-serif' }
                                });
                            }
                        }
                    });
                });
            }

            const layout = {
                title: { text: chartTitle, font: { family: 'Sarabun', size: 20 } },
                xaxis: { 
                    title: 'อัตราคัดกรอง (%)', titlefont: { size: 16 }, tickfont: { size: 16 },  automargin: true,
                    type: 'linear', tickangle: 0, 
                    range: [0, Math.max(100, Math.max(...percentages) * 1.2)], 
                    gridcolor: '#e0e0e0', gridwidth: 1
                }, 
                yaxis: { 
                    title: (isOverallGroupView || !isOverallHospitalView) ? 'กลุ่มความเสี่ยง' : 'สถานบริการ', 
                    titlefont: { size: 16 }, automargin: true, autorange: 'reversed', 
                    gridcolor: 'transparent', gridwidth: 0, showgrid: true, tickfont: { size: 16 }
                },
                margin: marginConfig, 
                plot_bgcolor: '#f9fafb', paper_bgcolor: '#ffffff',
                shapes: shapes, annotations: annotations, 
                height: calculatedHeight, 
                bargap: 0.1, barmode: 'stack', 
                legend: { orientation: 'h', y: 1.02, x: 0.5, xanchor: 'center', bgcolor: 'transparent', font: { size: 16 } }
            };
            
            const config = {
                displayModeBar: false, scrollZoom: false, modeBarButtonsToRemove: ['zoom2d', 'pan2d']
            };

            Plotly.newPlot(chartContainer, traces, layout, config);
        }

        function renderTable(data, hospitalFilter) {
            const tableContainer = document.getElementById('table-container');
            let html = '<table id="summaryTable" class="data-table w-full text-left">'; 
            html += '<thead class="bg-gray-200 text-gray-700 uppercase text-xs"><tr>';
            html += '<th class="px-6 py-3 rounded-tl-xl">สถานบริการ</th>';
            html += '<th class="px-6 py-3">กลุ่มความเสี่ยง</th>';
            html += '<th class="px-6 py-3 text-right">เป้าหมาย</th>';
            html += '<th class="px-6 py-3 text-right">ผลการคัดกรอง</th>';
            html += '<th class="px-6 py-3 text-right">เป้าคงเหลือ</th>';
            html += '<th class="px-6 py-3 text-right rounded-tr-xl">อัตราคัดกรอง (%)</th></tr></thead><tbody>';

            let dataToDisplay = [];
            
            if (hospitalFilter !== 'All' && data.length > 0) {
                 const hospitalDetails = data[0].details;

                 if (hospitalDetails && hospitalDetails.length > 0) {
                     dataToDisplay = hospitalDetails
                        .map(detail => ({
                            hospital: data[0].hospital,
                            riskGroup: detail.riskGroup,
                            target: detail.target,
                            screened: detail.screened,
                            remaining: detail.remaining,
                            percentage: detail.target > 0 ? (detail.screened / detail.target) * 100 : 0
                        }));
                     
                     dataToDisplay.sort((a, b) => {
                        const numA = parseFloat(a.riskGroup.split('.')[0]);
                        const numB = parseFloat(b.riskGroup.split('.')[0]);
                        return numA - numB; 
                    });
                 }


            } else {
                const validData = data.filter(d => d.hospital); 

                dataToDisplay = validData.map(d => ({
                    hospital: d.hospital,
                    riskGroup: '***รวมทั้งหมด***',
                    target: d.totalTarget,
                    screened: d.totalScreened,
                    remaining: d.totalTarget - d.totalScreened,
                    percentage: d.percentage
                }));

                dataToDisplay.sort((a, b) => b.percentage - a.percentage);
            }
            
            dataToDisplay.forEach((d, index) => {
                const rowClass = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                html += `<tr class="${rowClass} hover:bg-blue-100 transition duration-150">`;
                html += `<td class="px-6 py-4 whitespace-nowrap">${d.hospital || 'N/A'}</td>`; 
                html += `<td class="px-6 py-4 whitespace-nowrap text-left">${d.riskGroup}</td>`;
                html += `<td class="px-6 py-4 text-right">${d.target.toLocaleString()}</td>`;
                html += `<td class="px-6 py-4 text-right">${d.screened.toLocaleString()}</td>`;
                html += `<td class="px-6 py-4 text-right">${d.remaining.toLocaleString()}</td>`;
                html += `<td class="px-6 py-4 text-right font-medium ${d.percentage > 5 ? 'text-green-600' : 'text-red-600'}">${d.percentage.toFixed(2)}%</td>`;
                html += `</tr>`;
            });

            html += '</tbody></table>';
            tableContainer.innerHTML = html;
        }

        function populateFilter(data) {
            const filter = document.getElementById('hospitalFilter');
            const hospitals = Object.keys(data);
            
            const selectedValue = filter.value; 

            filter.innerHTML = '<option value="All">-- แสดงทั้งหมด --</option>';

            hospitals.sort().forEach(h => {
                const option = document.createElement('option');
                option.value = h;
                option.textContent = h;
                if (h === selectedValue) {
                    option.selected = true;
                }
                filter.appendChild(option);
            });
        }

        async function filterData() {
            // โหลดและประมวลผลข้อมูลหลัก (เร็ว)
            MOCK_DATA = await loadAllData(); 
            const currentSelectedHospital = document.getElementById('hospitalFilter').value;
            populateFilter(MOCK_DATA);
            document.getElementById('hospitalFilter').value = currentSelectedHospital;

            const selectedHospital = document.getElementById('hospitalFilter').value;
            const processed = processData(MOCK_DATA);
            
            const chartsArea = document.getElementById('charts-area');
            const validData = processed.filter(d => d.hospital);
            const isDataEmpty = validData.length === 0 || validData.every(d => d.totalTarget === 0);
            
            // Clear or update AI Analysis section for initial state
            const aiOutputDiv = document.getElementById('ai-analysis-output');
            aiOutputDiv.innerHTML = '<span class="text-gray-500">รอการประมวลผลการวิเคราะห์...</span>';


            if (isDataEmpty) {
                chartsArea.innerHTML = '<div class="text-center p-10 text-xl text-gray-500 bg-gray-100 rounded-lg">*** กรุณาเข้าสู่หน้า Admin เพื่อบันทึกข้อมูลเป้าหมายและการคัดกรอง ***</div>';
                document.getElementById('table-container').innerHTML = '<div class="text-center p-10 text-xl text-gray-500">ไม่มีข้อมูลการบันทึก กรุณาเข้าสู่หน้า Admin เพื่อเริ่มต้น</div>';
                aiOutputDiv.innerHTML = '<span class="text-gray-500">ไม่สามารถวิเคราะห์ได้ เนื่องจากไม่มีข้อมูล</span>';
                return;
            }

            // วาดกราฟและตาราง (เร็ว)
            chartsArea.innerHTML = ''; 

            if (selectedHospital === 'All') {
                const mainChartDiv = document.createElement('div');
                mainChartDiv.id = 'chart-main-overall';
                mainChartDiv.className = 'chart-plot-container w-full bg-white shadow-xl rounded-xl p-4 border border-gray-100';
                chartsArea.appendChild(mainChartDiv);
                drawChart(processed, false, 'chart-main-overall'); 
                
                const overallGroupData = getOverallGroupData(MOCK_DATA);
                const groupChartDiv = document.createElement('div');
                groupChartDiv.id = 'chart-group-comparison';
                groupChartDiv.className = 'chart-plot-container w-full bg-white shadow-xl rounded-xl p-4 border border-gray-100 mt-8'; 
                chartsArea.appendChild(groupChartDiv);
                drawChart(overallGroupData, true, 'chart-group-comparison', 'อัตราการคัดกรองรวม: แยกตามกลุ่มความเสี่ยง (ทุกสถานบริการรวมกัน)');
                
                renderTable(processed, 'All');
                
                // *** 3. AI Analysis (NON-BLOCKING) ***
                // เราจะเรียกฟังก์ชันโดยไม่มี await เพื่อให้โค้ดส่วนอื่นทำงานต่อทันที
                generateAIAnalysis(processed, overallGroupData, selectedHospital);


            } else {
                const hospitalData = processed.filter(d => d.hospital === selectedHospital);
                
                if (hospitalData.length === 0 || hospitalData[0].totalTarget === 0) {
                     chartsArea.innerHTML = `<div class="text-center p-10 text-xl text-gray-500 bg-gray-100 rounded-lg">ไม่พบข้อมูลการคัดกรองสำหรับ ${selectedHospital}</div>`;
                     document.getElementById('table-container').innerHTML = '';
                     return;
                }
                
                const mainChartDiv = document.createElement('div');
                mainChartDiv.id = 'chart-main-comparison';
                mainChartDiv.className = 'chart-plot-container w-full bg-white shadow-xl rounded-xl p-4 border border-gray-100';
                chartsArea.appendChild(mainChartDiv);

                const comparisonData = getGroupComparisonData(hospitalData);
                drawChart(comparisonData, true, 'chart-main-comparison');

                renderTable(hospitalData, selectedHospital); 
                
                // *** 3. AI Analysis *** (เรียกแบบ Non-blocking เช่นกัน)
                generateAIAnalysis(processed, [], selectedHospital);
            }
        }

        // --- INITIALIZATION ---
        window.onload = async function() {
            await filterData(); 
            // NOTE: event listener ถูกเพิ่มใน HTML (onchange="filterData()") อยู่แล้ว 
            // แต่ควรเพิ่มตรงนี้เพื่อความชัดเจน (ถึงแม้ใน HTML จะมีอยู่แล้วก็ตาม)
            document.getElementById('hospitalFilter').addEventListener('change', filterData);
        };
    </script>
</body>
</html>
